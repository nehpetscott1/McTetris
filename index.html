<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tetris — MC Classroom + Tutorial (SRS/T-Spin/PC)</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet"/>
</head>
<body>
  <div class="container">
    <h1 class="title">T  E  T  R  I  S</h1>

    <div class="game-layout">
      <!-- Left panel -->
      <div class="side-panel">
        <div class="panel-title">SCORE</div>
        <div class="score-item"><span>Score:</span><span class="score-value" id="score">0</span></div>
        <div class="score-item"><span>Lines:</span><span class="score-value" id="lines">0</span></div>
        <div class="score-item"><span>Level:</span><span class="score-value" id="level">1</span></div>

        <div class="panel-title" style="margin-top:1.2rem;">HOLD</div>
        <div class="mini-grid" id="holdBox"></div>

        <div class="panel-title" style="margin-top:1.2rem;">NEXT</div>
        <div class="mini-list" id="nextList">
          <div class="mini-grid"></div>
          <div class="mini-grid"></div>
          <div class="mini-grid"></div>
          <div class="mini-grid"></div>
          <div class="mini-grid"></div>
        </div>
      </div>

      <!-- Board -->
      <div class="game-board" id="gameBoard"></div>

      <!-- Right panel -->
      <div class="side-panel">
        <div class="panel-title">CONTROLS</div>
        <div class="controls">
          <button class="btn btn-primary" id="startBtn">START GAME</button>
          <button class="btn hidden" id="pauseBtn">PAUSE</button>
          <button class="btn" id="rotateBtn">ROTATE</button>
          <button class="btn" id="dropBtn">HARD DROP</button>
          <button class="btn" id="holdBtn">HOLD</button>
          <button class="btn" id="keysBtn">KEY BINDS</button>
          <button class="btn" id="tutorialBtn">TUTORIAL</button>
        </div>

        <div class="panel-title" style="margin-top:1rem;">KEYS</div>
        <div style="font-size:.85rem; line-height:1.5;">
          <div>← → : Move &nbsp; | &nbsp; ↓ : Soft Drop</div>
          <div>↑ / Space : Rotate &nbsp; | &nbsp; Enter: Hard Drop</div>
          <div>C / Shift : Hold &nbsp; | &nbsp; P : Pause</div>
        </div>

        <div class="panel-title" style="margin-top:1.2rem;">MC CLASSROOM</div>
        <div class="opt">
          <label><input type="checkbox" id="optAdaptive" checked/> Adaptive Mode</label><span></span>
          <label>Lock Delay</label><input type="range" id="optLock" min="200" max="800" value="500"/>
          <label>Daily Seed</label><input type="checkbox" id="optDaily"/>
          <label>Seed</label><input type="number" id="optSeed" value="0" min="0" step="1"/>
          <label>Queue Size</label>
          <select id="optQueue"><option>5</option><option>4</option><option>3</option></select>
          <label><input type="checkbox" id="optGhost" checked/> Ghost Piece</label><span></span>
          <label><input type="checkbox" id="optSymbolic"/> Symbolic Score Boost</label><span></span>
          <button class="btn" id="exportBtn">Export CSV</button><span></span>
        </div>
      </div>
    </div>

    <!-- Start Modal -->
    <div class="modal" id="startModal">
      <div class="modal-content">
        <div class="modal-title">T  E  T  R  I  S</div>
        <div class="modal-text">Classic puzzle — SRS, T-Spins, Perfect Clears, MC classroom analytics, and a guided tutorial.</div>
        <div style="display:flex; gap:.6rem; flex-wrap:wrap;">
          <button class="btn" onclick="openTutorial()" style="flex:1;">TUTORIAL</button>
          <button class="btn btn-primary" onclick="startGame()" style="flex:1;">START GAME</button>
        </div>
        <div style="margin-top:1rem; font-size:.8rem; opacity:.7;">Press SPACE or ENTER to start</div>
      </div>
    </div>

    <!-- Game Over Modal -->
    <div class="modal hidden" id="gameOverModal">
      <div class="modal-content">
        <div class="modal-title">GAME OVER</div>
        <div class="modal-stats">
          <div class="stat-item"><div class="stat-value" id="finalScore">0</div><div class="stat-label">SCORE</div></div>
          <div class="stat-item"><div class="stat-value" id="finalLines">0</div><div class="stat-label">LINES</div></div>
          <div class="stat-item"><div class="stat-value" id="finalLevel">1</div><div class="stat-label">LEVEL</div></div>
          <div class="stat-item"><div class="stat-value" id="finalLPM">0</div><div class="stat-label">LPM</div></div>
          <div class="stat-item"><div class="stat-value" id="finalTSpins">0</div><div class="stat-label">T-SPINS</div></div>
          <div class="stat-item"><div class="stat-value" id="finalPCs">0</div><div class="stat-label">PERFECT CLEARS</div></div>
        </div>
        <button class="btn btn-primary" onclick="startGame()" style="width:100%;">PLAY AGAIN</button>
        <div style="margin-top:1rem; font-size:.8rem; opacity:.7;">Press SPACE or ENTER to start a new game</div>
      </div>
    </div>

    <!-- Pause Modal -->
    <div class="modal hidden" id="pauseModal">
      <div class="modal-content">
        <div class="modal-title">PAUSED</div>
        <div class="modal-text">Press P to continue</div>
      </div>
    </div>

    <!-- Keybinds Modal -->
    <div class="modal hidden" id="keysModal">
      <div class="modal-content">
        <div class="modal-title">KEY BINDS</div>
        <div class="kbd-grid">
          <label>Left</label><input id="kbLeft"  placeholder="ArrowLeft"/>
          <label>Right</label><input id="kbRight" placeholder="ArrowRight"/>
          <label>Soft Drop</label><input id="kbDown"  placeholder="ArrowDown"/>
          <label>Rotate</label><input id="kbRotate" placeholder="ArrowUp / Space"/>
          <label>Hard Drop</label><input id="kbHard"  placeholder="Enter"/>
          <label>Hold</label><input id="kbHold"  placeholder="C / Shift"/>
          <label>Pause</label><input id="kbPause" placeholder="P"/>
        </div>
        <div style="display:flex; gap:.6rem; justify-content:center; margin-top:1rem;">
          <button class="btn" id="kbCancel">Cancel</button>
          <button class="btn btn-primary" id="kbSave">Save</button>
        </div>
      </div>
    </div>

    <!-- Tutorial Modal -->
    <div class="modal hidden" id="tutorialModal">
      <div class="modal-content" style="max-width:720px;">
        <div class="modal-title">TUTORIAL</div>
        <div id="tutBody" class="tut-body"></div>
        <div class="tut-nav">
          <button class="btn" id="tutPrev">Back</button>
          <button class="btn" id="tutExit">Exit</button>
          <button class="btn btn-primary" id="tutNext">Next</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // All your game code goes here, with fixes
    // ... [the entire JavaScript from before, with the following changes:]

    // --- After your button references, add: ---
    startBtn.addEventListener('click', startGame);

    // --- In function srsRotateCW, fix kicks table lookup: ---
    function srsRotateCW(piece){
      const from=piece.o, to=(piece.o+1)&3;
      const cand=rotCW(piece.shape);
      if(piece.type==='O'){
        if(validAt(state.board,piece,piece.x,piece.y,cand)) return {ok:true,x:piece.x,y:piece.y,shape:cand,o:to,kicked:false};
        return {ok:false};
      }
      const table = (piece.type==='I')?SRS_I:SRS_JLSTZ;
      const kicks = table[`${from}>${to}`]; // <-- FIXED
      for(const [dx,dy] of kicks){
        const nx=piece.x+dx, ny=piece.y+dy;
        if(validAt(state.board,piece,nx,ny,cand)) return {ok:true,x:nx,y:ny,shape:cand,o:to,kicked:!(dx===0&&dy===0)};
      }
      return {ok:false};
    }

    // --- Add semicolons at the end of all statements in your JS ---

    // --- The rest of the code remains the same, but now the Start button will always work ---
    // (If you want the full JS pasted inline, let me know, but for clarity, just add these two changes.)
  
    // --- Expose startGame and openTutorial for modal buttons ---
    window.startGame = startGame;
    window.openTutorial = openTutorial;

    // --- Boot ---
    try{ makeBoard(); drawHold(); drawNext(); } catch(e){ console.error(e); gameBoard.innerHTML='<div style="color:#ff5a5a;padding:1rem;text-align:center;">Load error. See console.</div>'; }
  </script>
</body>
</html>
